# Comments on Trust Expressions / Trust Anchors Use Cases

This document analyses the use cases proposed for the Trust Expressions and Trust Anchors drafts. These use cases are sourced from the relevant sections in the drafts, and the accompanying [explainer](https://github.com/davidben/tls-trust-expressions/blob/main/explainer.md) and [pki-transitions](https://github.com/davidben/tls-trust-expressions/blob/main/pki-transition-strategies.md) documents. The analysis looks to evaluate:

* Is the proposed problem compelling? Does it need to be solved?
* To what extent do the drafts solve the problem and under what deployment assumptions?
* How does it compare to the alternatives?

## Summary

Trust Expressions and Trust Anchors are both very general systems which describe a broad range of possible use cases. However, I feel most of these problems are not important or pressing and do not warrant substantial investment to solve.

Even accepting the problems as in need of serious effort to solve, I am skeptical of the deployment and operational aspects of Trust Expressions and Trust Anchors, where the drafts’ proposed benefits rest heavily on voluntary adoption of these features by the websites and clients that are the least likely to proactively adopt this kind of technology  and have little incentive to incur the adoption costs themselves.

I think the most interesting problem that these designs try to tackle is the transition to a Post-Quantum PKI. Whilst I agree on the importance of this problem, I do not believe Trust Expressions or Trust Anchors is a satisfactory solution. Existing technology can already achieve the same outcomes and benefits that Trust Expressions claims to deliver and can do so without the substantial investment needed by these proposals. This also avoids the risks described in the accompanying [document](https://github.com/dennisjackson/trust-negotiation-comments/blob/main/concerns-and-risks.md).

## Rotating Root Keys

The first use case described in the proposals is making root key rotation in the WebPKI easier. Currently, the WebPKI has several ~20-year-old root keys which are used to sign shorter lived intermediate certificates.

The proposals describe this as a security risk and propose a new solution. CAs can generate new root certificates, generate two chains corresponding to new and old certificates and then use Trust Expressions or Trust Anchors to negotiate whether to send the new chain (to up-to-date clients) or the old chain (to older clients).

I believe this part of the proposal misses a few key facts about the existing WebPKI, which means this issue is much less of a problem than might first appear. This is partly because root certificate private keys actually offer fewer capabilities to attackers than intermediate certificate private keys and partly because there are existing solutions which already allow for this rotation without requiring new technology to be deployed.

The first key fact is that all major root programs require that CAs disclose all intermediate certificates to the public [Common CA Database](https://www.ccadb.org/) (CCADB) before they are used. The existence of an undisclosed intermediate certificate is considered an incident by itself.

This means that an attacker who compromises a root certificate private key actually is unable to attack any client who enforces Certificate Transparency without publicly revealing that the root certificate has been compromised, since they will need to craft a new certificate chain which does not go through a CCADB disclosed intermediate. For this reason, compromising an existing intermediate certificate is actually more valuable to an attacker, and these intermediate keys are already rotated much more frequently.

The second aspect is that both clients and CAs can unilateral rotate these old keys themselves, without the need to coordinate or deploy new technology like Trust Expressions or Trust Anchors.

Clients can withdraw trust in these older root keys by instead selecting their shorter lived intermediate certificates as trust anchors. These intermediates are generated much more frequently and are already widely distributed to browsers via the CCADB. This solution only works for clients that can stay up to date and if they go an extended period without updates, the browser can automatically fallback to trusting the corresponding root certificates. This is similar to existing certificate transparency mechanisms which self-disable after around 8 weeks. Clients that choose to anchor trust in the intermediates and clients that choose to anchor trust in the roots can both consume the same certificate chain without issues.

CAs can generate new root keys and ‘self cross-sign’ their new root with their existing root. This maximizes compatibility, meaning that old and new clients will trust certificates issued by the new root. The CA can then retire the older root key. This technique is already widely used for when CAs migrate between signature algorithms (e.g. RSA to ECDSA) and will be useful for the transition to PQ signatures in the Web PKI (discussed further below).

## Handling Older Clients

The drafts also suggest that adopting Trust Expressions or Trust Anchors is necessary to maintain support for older clients which are not receiving updates to their root stores. I am doubtful this is a real issue on the WebPKI today, the largest sites in the world like google.com, facebook.com can provide a single certificate chain which is acceptable to all old and new clients. However, some of these sites will have two certificate chains corresponding to newer, smaller signatures (e.g. ECDSA) served to modern clients for performance and an older, larger RSA chain which is more backwards compatible, but this is a performance optimisation based on heuristics rather than a necessary choice.

It is also the case that the vast majority of devices with old root stores belong to Android devices. This is because whilst every other operating system makes it easy for their clients to receive root store updates, Android historically required each manufacturer to deliver a specific firmware OTA update in order to update the system root store, which composed poorly with older devices limited support windows. Google recently [fixed this problem](https://www.xda-developers.com/android-14-root-certificates-updatable/) in Android 14 released in October 2023, which allows for the system root store to be updated independently via the Google Play Store. This suggests old devices will be much less of an issue in the future. 

Two further developments will also prevent this being a problem in the future. The [EU](https://digital-strategy.ec.europa.eu/en/policies/cyber-resilience-act) and the [UK](https://www.ncsc.gov.uk/files/Security-law-smart-devices-NCSC.pdf) already have laws that require all device manufacturers to offer security updates for the full lifetime of the device, ensuring manufacturers are incentivised to keep device’s root stores updated. Further, with the coming shift to post-quantum cryptography, CAs will need to generate new post-quantum roots. It is likely that these roots will have a lifetime as short as 7 years ([as proposed by Google](https://www.chromium.org/Home/chromium-security/root-ca-policy/moving-forward-together/)), instead of the two to three decades that existing roots enjoy. This will ensure that older devices will fail-secure and can no longer work after their roots expire.

Together, this paints a picture that this issue is a not a problem today and will not be a problem in the future. On the other hand, I believe adopting a solution like Trust Expressions or Trust Anchors could actually dramatically worsen this situation, by effectively giving permission for manufacturers to not pro-actively update their devices and instead pushing the pain onto websites who would need to meet an ever-growing list of older root store requirements.

## Adopting a CA new to the Root Programs

Another use case described in the drafts is making it easier for new CAs to be adopted by websites. I don’t really understand the motivation for this use case, as I feel it should probably be harder to add new CAs to Root Stores rather than easier.

Nor is there any shortage of ubiquitous CAs for websites to choose from. I did a brief analysis through the CCADB for root certificates which are universally trusted by the Mozilla, Microsoft, Apple and Google Root Programs and the year they were introduced. The dataset from June 13th is available [here](https://docs.google.com/spreadsheets/d/1UeVDVylRnQ6ReaTcAwUJRGydv8B2sc3mJTP3GBydewc/edit?usp=sharing) and lists 28 different CAs with roots older than 2014 and 37 with roots older than 2017.

Further, even if it were the case we needed to make it easier to adopt new CAs, neither Trust Expessions nor Trust Anchors is likely to make a difference in practice. This is because website operators are motivated to make their TLS deployment as simple and as low-cost as possible. If an operator wants to use a new CA with Trust Expressions, they will still need to use an additional CA for all the other clients whose local root stores do not yet contain the new CA. This is literally doubling (or more) the work of the website operator in return for no improvement over using an existing single ubiquitous CA.

## Removing a CA / Handling Root Program CA Distrusts

From time to time, it emerges that a CA has misbehaved and one or more Root Programs decide to withdraw trust in that particular CA. When these CAs are small and little-used, this is a relatively painless process, but the situation is more challenging when the CA is popular and/or used by critical infrastructure. An example of these events would be Diginotar in 2011, Symantec in 2016, and Entrust in 2024. The Trust Expressions and Trust Anchors drafts claim that they could alleviate the challenges in managing these large scale distrust events and make them easier to carry out.

There are several issues with this argument. Firstly, the frequency of events of this magnitude is extremely low and around the order of one per decade. This means the magnitude of the benefit that Trust Expressions could deliver is already quite limited. We now have to look more closely at what can make these events difficult to carry out from the perspective of root store operators to understand the sources of the pain and why these proposals won’t help.

The first source of pain comes from the existing websites which use the distrusted CA and now need to migrate to a new CA and renew their certificates. This typically requires a few months of notice to accomplish, but is largely a straightforward process. The Trust Expressions draft claims that this switchover could be made much faster or even instant. This is simply impossible.

This would rely on nearly every website operator not only implementing Trust Expressions or Trust Anchors and concluding an agreement with their existing CA, but a separate independent agreement with a backup CA. Expecting a large fraction of website operators to incur extra costs and do additional work on the off-chance that their primary CA will one day be distrusted is unrealistic in the extreme. The minority of website operators who will go to this level of preparation can already quickly swap to their backup certificate chain which they can provision with automated mechanisms like ACME, so these proposals does not deliver any new capabilities for them either.

A second source of pain from these major distrusts largely comes from major websites which are accessed both by browsers and by another type of hard to update device which pins the distrusted CA’s root certificate. This places the website in a difficult situation where it can’t migrate to a new CA without breaking the other devices which use pinning. Consequently, root programs have to delay enforcement of their distrust decisions in order to allow these devices to be updated or some other solution to be found. I believe in at least one instance this involved detecting the TLS fingerprint of the devices performing the pinning (which is very distinct from the TLS fingerprint of a browser) and serving them the old certificate chain.

Thankfully, this kind of pinning of a single CA is increasingly rare and runs counter to best practices. If the devices performing pinning are instead careful to pin both an intended CA and one or more backup CAs, the problem largely disappears entirely. This also ensures that the devices will continue to work if the CA simply becomes unable to issue new certificates for a financial or operational issue. I expect the recent decision by the Chrome Root Program to distrust Entrust will be a useful litmus test of the pain involved in these distrust decisions.

Other advances in technology have reduced the need for browsers / Root Programs to perform these kinds of sudden distrusts at all. Instead, Root Programs can perform gradual distrusts which gracefully sunset a CA, without the need to set a single harsh cutoff dates because of advances like CT-enforced Distrust-After dates, as [recently introduced by Chrome](https://security.googleblog.com/2024/06/sustaining-digital-certificate-security.html), which are as equally secure for users as sudden distrusts. Especially when combined with effective revocation mechanisms like CRLite.

These gradual distrusts are also much more effective in encouraging the customer base of the removed CA to migrate to a new CA gracefully by allowing the root program to distrust certificates issued by that CA gradually, which is a secondary factor in the timelines required for distrust decisions.

Putting this context aside and solely considering the effectiveness of Trust Expressions or Trust Anchors for performing sudden CA distrusts, I feel it is still quite unlikely to prove effective. Firstly, Trust Expressions would need to be deployed in advance on the tiny minority of servers which are accessed by devices with these kinds of pins. This is unlikely unless Trust Expressions achieves an unprecedented widespread deployment. There is also good reason to think that the relevant sites are much more likely to be using ancient versions of Apache on extended support contracts with TLS1.2 than the latest and greatest TLS1.3 features and so least likely to deploy it in advance. 

This issue is compounded when we consider the client adoption scenario. Trust Expressions will only help these affected sites in a particular circumstance: all relevant clients who are performing the sudden distrust will adopt Trust Expressions and so allow the site to  determine accurately which clients need the new or old certificate. This leaves the site able to serve the old certificate ‘by default’. However, this strategy will not be effective if the site has at least one client base who does not implement Trust Expressions and is going to perform the distrust.

Critically, the effectiveness of Trust Expressions for this use case relies both on ubiquitous server-side and client-side support which is unlikely to ever be realistic given the adoption rates of current TLS1.3 features and the relative complexity of Trust Expressions and Trust Anchors, which requires changes to both the client’s TLS implementation and their OS-specific root store implementation.

Ultimately, I believe this use case is not valuable because of the lack of actual pain suffered in the real world and the existing alternative of deploying secure but gradual distrusts. To achieve any benefit, Trust Expressions and Trust Anchors would need to find very widespread deployment, but even if so, this use case only has benefits for a very limited set of actors - essentially just root program operators and the rare websites with lots of pinned clients who have their CA distrusted - which is essentially impossible to predict in advance.

## Transitioning the Web to a Post-Quantum PKI

Transitioning the Web to a PQ PKI is clearly an important and complex problem. The Trust Expression’s draft identifies two complementary use cases. Firstly, to improve trust agility during the initial stages of deployment and work around clients with different versions of PQ Root Stores. Secondly, to minimize the number of bytes sent in TLS Certificate Messages. A third use case not described in the drafts, but proposed by others, is that Trust Expressions might be a useful negotiation mechanism for deploying other designs. Each use case is discussed separately.

### Trust Agility

As clients add support for PQ signatures and certificates, they will signal it in their TLS `signature_algorithms` extension. This allows the TLS server to decide whether to send a purely classical certificate chain, or a PQ certificate chain. However, in the initial stages of the transition, clients may have PQ-signature support but only a subset of the PQ roots. As CAs generate new PQ roots, websites will want to enable support, but be unsure whether the root they use has achieved ubiquity amongst clients advertising PQ-signature support, which could slow down deployment.

Trust Expressions and Trust Anchors propose to address this problem by allowing clients to negotiate which certificate the server sends and so avoid any issues with missing root certificates. This solves the described problem, but perhaps surprisingly does not achieve any improvements over existing solutions, which are already ubiquitously supported today.

When a CA creates a new root, they will typically sign their new root certificate with their older root. This type of ‘self cross-signing’ (where both roots are controlled by the same CA) has is widely practiced across the PKI and has been for over a decade, for example by [Let’s Encrypt](https://letsencrypt.org/certificates/), [Digicert](https://knowledge.digicert.com/tutorials/install-the-digicert-g5-cross-signed-root-ca-certificate) and [Sectigo](https://support.sectigo.com/articles/Knowledge/Sectigo-Chain-Hierarchy-and-Intermediate-Roots).

These ‘self’ cross-signs solve the exact problem that Trust Expressions is proposing to solve and don’t require any new code or technology to be deployed on clients or servers. During the PQ transition phase, servers can deploy new PQ roots, which are in turn signed by older classical roots. This maximizes both availability (clients without the new PQ root, but PQ signature support will build a trust chain back to the classical root) and security (clients with the new PQ root, will terminate their trust chain with the new PQ root and ignore the classical signature) and delivers an outcome identical to that claimed by Trust Expressions.

Further, thanks to existing certificate compression schemes like Brotli and ZStd, these classical self ‘cross-signs’ can be deployed with very little bandwidth overhead, as little as an extra 64 bytes for the classical cross-sign which is tiny considering the multi-kilobyte PQ signatures in the chain. This approach does not require any path building support by clients. Other approaches like Intermediate Suppression and Abridged Certs, discussed further in the next section, deliver even better improvements.

This approach is described further, with the technical details, in a thread on the TLS mailing list ([1](https://mailarchive.ietf.org/arch/msg/tls/b_S23Rk0yvleoT3D0BGUTYFut80/),[2](https://mailarchive.ietf.org/arch/msg/tls/hksk76_5CTarYH8vBtnhOu4pkZ0/)).

### Certificate Chain Size

Another issue with the PQ transition is that PQC signatures are rather large and so, for performance reasons, we would like to remove as many of them as possible from the TLS Handshake. Both Trust Expressions and Trust Anchors allow the server to omit any unnecessary intermediate certificates.

This is identical in outcome to that achieved by the already adopted [Abridged Certificate Compression](https://datatracker.ietf.org/doc/draft-ietf-tls-cert-abridge/) draft, as well as the previously proposed [Suppress Intermediates](https://www.ietf.org/archive/id/draft-kampanakis-tls-scas-latest-03.html) draft. Both existing solutions are also much simpler than Trust Expressions with fewer working parts and synchronization requirements between clients, servers, CAs and root programs.

In particular, Trust Expressions and Trust Anchors requires invasive changes to the existing APIs used by TLS libraries and root stores. This includes integration with all existing operating systems on clients and the certificate discovery and selection callbacks in server-side software. Further, new software to support Trust Expressions and Trust Anchors needs to be deployed by CAs and in ACME clients. Meanwhile, the Abridged Certificate Compression Scheme fits within the existing TLS Certificate Compression extension and does not require any further changes to TLS libraries, operating systems or applications. As a consequence, Abridged Certs can be deployed by TLS library maintainers transparently without having to rework operating system root stores or server-side applications.

The Trust Expression’s [explainer](https://github.com/davidben/tls-trust-expressions/blob/main/explainer.md) discusses the role of Abridged Certificates in the PQ transition but makes some mistakes around how the scheme works, in particular claiming that it is static and so cannot handle future transitions. This is incorrect. As the Abridged Certs draft describes, it is intended to be versioned yearly in line with existing root store policies. Further, because Abridged Certs does not affect trust decisions, it can compress intermediate and root certificates that are currently candidates for inclusions without any security risks, which ensures that new CAs can compete on the same footing as incumbents. Finally, Annex B of the draft describes a dynamic negotiation mechanism that supports both private PKIs and on-demand versioning at arbitrary intervals.

### Deploying New PKI Designs

Although the Trust Expressions and Trust Anchors drafts do not describe this use case, others have suggested that Trust Expressions could enable the deployment of new designs for the Web PKI, for example, the [Merkle Tree Certificates (MTC)](https://datatracker.ietf.org/doc/draft-davidben-tls-merkle-tree-certs/) draft. Whilst these ideas are promising, they still have several open unsolved problems which would need to be addressed before they could represent viable designs for a future WebPKI. In particular, MTC currently has no choice to fall back to existing X.509-based certificates in some circumstances, even when both client and server support MTC. MTC also currently falls far short of the security properties achieved by the existing Certificate Transparency system.

Once the proposals like MTC have been developed into workable designs, they will need to ship with their own negotiation mechanism. The deployment or non-deployment of Trust Expressions or Trust Anchors does not have any bearing on practicality and effectiveness of these next generation proposals. Consequently, whilst we should continue to develop proposals like MTC into viable designs, this should not affect the evaluation of Trust Expressions or Trust Anchors, which are drafts primarily aimed changing the existing X.509 ecosystem.
